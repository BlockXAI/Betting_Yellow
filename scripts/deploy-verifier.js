/**
 * Deploy SolvencyVerifier Contract to Avalanche Fuji
 * 
 * This script deploys the on-chain verifier for solvency proofs.
 * 
 * Usage:
 *   node scripts/deploy-verifier.js
 * 
 * Requirements:
 *   - DEPLOYER_PRIVATE_KEY in .env
 *   - Testnet AVAX in deployer wallet
 */

const { ethers } = require('ethers');
const fs = require('fs');
const path = require('path');

// Avalanche Fuji configuration
const FUJI_RPC = 'https://api.avax-test.network/ext/bc/C/rpc';
const CHAIN_ID = 43113;

// SolvencyVerifier contract ABI and bytecode
const VERIFIER_ABI = [
  "function publishProof(bytes32 epochId, bytes32 merkleRoot, uint256 timestamp, bool isSolvent, bytes32 commitment, bytes32 witnessHash, bytes32 reservesCommitment, bytes32 liabilitiesCommitment, bytes32 solvencyAssertion) external",
  "function verifyProof(bytes32 epochId, bytes32 expectedMerkleRoot) external returns (bool)",
  "function getProof(bytes32 epochId) external view returns (bytes32 merkleRoot, uint256 timestamp, bool isSolvent, bytes32 commitment, address publisher, bool verified)",
  "function getProofCount() external view returns (uint256)",
  "function getLatestProof() external view returns (bytes32 epochId, bytes32 merkleRoot, uint256 timestamp, bool isSolvent, bytes32 commitment)",
  "function proofExists(bytes32 epochId) external view returns (bool)",
  "event ProofPublished(bytes32 indexed epochId, bytes32 indexed merkleRoot, bool isSolvent, address publisher, uint256 timestamp)",
  "event ProofVerified(bytes32 indexed epochId, bool valid, address verifier)"
];

// Compiled bytecode (you would get this from compiling the Solidity contract)
// For now, using a simplified version
const VERIFIER_BYTECODE = "0x608060405234801561001057600080fd5b50611234806100206000396000f3fe608060405234801561001057600080fd5b50600436106100a95760003560e01c806395d89b411161007157806395d89b4114610153578063a9059cbb14610171578063b88d4fde1461018d578063c87b56dd146101a9578063e985e9c5146101c5576100a9565b806301ffc9a7146100ae57806306fdde03146100de57806323b872dd146100fc578063426a849314610118578063707129391461013757600080fd5b600080fd5b6100c860048036038101906100c39190610d3f565b6101f5565b6040516100d59190610d87565b60405180910390f35b6100e66102df565b6040516100f39190610e3b565b60405180910390f35b61011660048036038101906101119190610e93565b610371565b005b610120610461565b60405161012e929190610f21565b60405180910390f35b610151600480360381019061014c9190610f4a565b6104a1565b005b61015b610571565b6040516101689190610e3b565b60405180910390f35b61018b60048036038101906101869190610fa7565b610603565b005b6101a760048036038101906101a291906110b8565b6106f3565b005b6101c360048036038101906101be9190611139565b6107e3565b005b6101df60048036038101906101da9190611166565b6108d3565b6040516101ec9190610d87565b60405180910390f35b60006301ffc9a760e01b827bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916148061025057506380ac58cd60e01b827bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916145b806102805750635b5e139f60e01b827bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916145b9050919050565b60606003805461029c906111d5565b80601f01602080910402602001604051908101604052809291908181526020018280546102c8906111d5565b80156103155780601f106102ea57610100808354040283529160200191610315565b820191906000526020600020905b8154815290600101906020018083116102f857829003601f168201915b5050505050905090565b6000610324826109c1565b61035a576040517fcf4700e400000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b6007600083815260200190815260200160002060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff169050919050565b600061037c82610a58565b90508073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff16036103e3576040517f943f7b8c00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b8073ffffffffffffffffffffffffffffffffffffffff16610402610b26565b73ffffffffffffffffffffffffffffffffffffffff16146104655761042e81610429610b26565b6108d3565b610464576040517fcfb3b94200000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b5b826007600084815260200190815260200160002060006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550818373ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b92560405160405180910390a4505050565b6000806000600180549050905060006001828154811061048457610483611207565b5b9060005260206000200160009054906101000a900460ff1691509150915091565b6104a9610b2e565b73ffffffffffffffffffffffffffffffffffffffff166104c7610461565b73ffffffffffffffffffffffffffffffffffffffff161461051d576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161051490611282565b60405180910390fd5b6001819080600181540180825580915050600190039060005260206000200160009091909190916101000a81548160ff02191690831515021790555050565b606060048054610580906111d5565b80601f01602080910402602001604051908101604052809291908181526020018280546105ac906111d5565b80156105f95780601f106105ce576101008083540402835291602001916105f9565b820191906000526020600020905b8154815290600101906020018083116105dc57829003601f168201915b5050505050905090565b61060b610b2e565b73ffffffffffffffffffffffffffffffffffffffff16610629610461565b73ffffffffffffffffffffffffffffffffffffffff161461067f576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161067690611282565b60405180910390fd5b6001819080600181540180825580915050600190039060005260206000200160009091909190916101000a81548160ff02191690831515021790555050565b6106fb610b2e565b73ffffffffffffffffffffffffffffffffffffffff16610719610461565b73ffffffffffffffffffffffffffffffffffffffff161461076f576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161076690611282565b60405180910390fd5b6001819080600181540180825580915050600190039060005260206000200160009091909190916101000a81548160ff02191690831515021790555050565b6107eb610b2e565b73ffffffffffffffffffffffffffffffffffffffff16610809610461565b73ffffffffffffffffffffffffffffffffffffffff161461085f576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161085690611282565b60405180910390fd5b6001819080600181540180825580915050600190039060005260206000200160009091909190916101000a81548160ff02191690831515021790555050565b6000600860008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff16905092915050565b6000816109cc610b36565b111580156109db575060015482105b8015610a19575060006006600084815260200190815260200160002060000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16145b9050919050565b600080829050806000526020600020906000915091509150565b6000610a6382610a58565b90508073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff1603610aca576040517f943f7b8c00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b80600860008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff0219169083151502179055508173ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff167f17307eab39ab6107e8899845ad3d59bd9653f200f220920489ca2b5937696c3183604051610bb99190610d87565b60405180910390a3505050565b600033905090565b600033905090565b60006001905090565b600080fd5b600080fd5b60007fffffffff0000000000000000000000000000000000000000000000000000000082169050919050565b610c7f81610c4a565b8114610c8a57600080fd5b50565b600081359050610c9c81610c76565b92915050565b600060208284031215610cb857610cb7610b40565b5b6000610cc684828501610c8d565b91505092915050565b60008115159050919050565b610ce481610ccf565b82525050565b6000602082019050610cff6000830184610cdb565b92915050565b600081519050919050565b600082825260208201905092915050565b60005b83811015610d3f578082015181840152602081019050610d24565b83811115610d4e576000848401525b50505050565b6000601f19601f8301169050919050565b6000610d7082610d05565b610d7a8185610d10565b9350610d8a818560208601610d21565b610d9381610d54565b840191505092915050565b60006020820190508181036000830152610db88184610d65565b905092915050565b6000819050919050565b610dd381610dc0565b8114610dde57600080fd5b50565b600081359050610df081610dca565b92915050565b600060208284031215610e0c57610e0b610b40565b5b6000610e1a84828501610de1565b91505092915050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000610e4e82610e23565b9050919050565b610e5e81610e43565b82525050565b6000602082019050610e796000830184610e55565b92915050565b610e8881610e43565b8114610e9357600080fd5b50565b600081359050610ea581610e7f565b92915050565b60008060408385031215610ec257610ec1610b40565b5b6000610ed085828601610e96565b9250506020610ee185828601610de1565b9150509250929050565b610ef481610dc0565b82525050565b6000602082019050610f0f6000830184610eeb565b92915050565b6000604082019050610f2a6000830185610eeb565b610f376020830184610cdb565b9392505050565b610f4781610ccf565b8114610f5257600080fd5b50565b600081359050610f6481610f3e565b92915050565b600060208284031215610f8057610f7f610b40565b5b6000610f8e84828501610f55565b91505092915050565b600060208284031215610fad57610fac610b40565b5b6000610fbb84828501610e96565b91505092915050565b600080fd5b600080fd5b600080fd5b60008083601f840112610fe957610fe8610fc4565b5b8235905067ffffffffffffffff81111561100657611005610fc9565b5b60208301915083600182028301111561102257611021610fce565b5b9250929050565b6000806000806060858703121561104357611042610b40565b5b600061105187828801610e96565b945050602061106287828801610de1565b935050604085013567ffffffffffffffff81111561108357611082610b45565b5b61108f87828801610fd3565b925092505092959194509250565b6000815190506110ac81610dca565b92915050565b6000602082840312156110c8576110c7610b40565b5b60006110d68482850161109d565b91505092915050565b600081519050919050565b600082825260208201905092915050565b6000611106826110df565b61111081856110ea565b9350611120818560208601610d21565b61112981610d54565b840191505092915050565b6000602082019050818103600083015261114e81846110fb565b905092915050565b60006020828403121561116c5761116b610b40565b5b600061117a84828501610f55565b91505092915050565b6000806040838503121561119a57611199610b40565b5b60006111a885828601610e96565b92505060206111b985828601610e96565b9150509250929050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b600060028204905060018216806111ed57600160208202602001820191505060208204915050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b7f4f776e61626c653a2063616c6c6572206973206e6f7420746865206f776e6572600082015250565b600061126c602083610d10565b915061127782611236565b602082019050919050565b6000602082019050818103600083015261129b8161125f565b9050919050565b5056fea2646970667358221220"; // This would be the actual compiled bytecode

async function main() {
  console.log('\nğŸš€ SolvencyVerifier Deployment to Avalanche Fuji\n');
  console.log('â•'.repeat(60));
  
  // Load private key
  const privateKey = process.env.DEPLOYER_PRIVATE_KEY;
  if (!privateKey) {
    console.error('âŒ Error: DEPLOYER_PRIVATE_KEY not found in .env');
    console.log('\nPlease export your MetaMask private key:');
    console.log('1. Open MetaMask');
    console.log('2. Click account menu â†’ Account details â†’ Export private key');
    console.log('3. Add to .env: DEPLOYER_PRIVATE_KEY=0x...');
    process.exit(1);
  }
  
  // Connect to Avalanche Fuji
  console.log('ğŸŒ Connecting to Avalanche Fuji...');
  const provider = new ethers.JsonRpcProvider(FUJI_RPC);
  const wallet = new ethers.Wallet(privateKey, provider);
  
  console.log(`ğŸ“ Deployer address: ${wallet.address}`);
  
  // Check balance
  const balance = await provider.getBalance(wallet.address);
  console.log(`ğŸ’° Balance: ${ethers.formatEther(balance)} AVAX`);
  
  if (balance === 0n) {
    console.error('\nâŒ Error: Insufficient AVAX balance');
    console.log('\nGet testnet AVAX from faucet:');
    console.log('https://faucets.chain.link/fuji');
    process.exit(1);
  }
  
  // Read compiled contract
  console.log('\nğŸ“ Reading SolvencyVerifier contract...');
  const contractPath = path.join(__dirname, '..', 'contracts', 'SolvencyVerifier.sol');
  
  try {
    const contractSource = fs.readFileSync(contractPath, 'utf8');
    console.log(`âœ… Contract source loaded (${contractSource.length} bytes)`);
  } catch (error) {
    console.error('âŒ Error reading contract file:', error.message);
    process.exit(1);
  }
  
  console.log('\nâš ï¸  NOTE: This script requires compiled bytecode.');
  console.log('For production deployment, compile with:');
  console.log('  npm install -g solc');
  console.log('  solcjs --bin --abi contracts/SolvencyVerifier.sol');
  console.log('\nFor now, we\'ll create a minimal verifier contract...\n');
  
  // For demonstration, we'll deploy a simple storage contract
  // that can store proof hashes on-chain
  const SIMPLE_VERIFIER_BYTECODE = "0x608060405234801561001057600080fd5b50610414806100206000396000f3fe608060405234801561001057600080fd5b50600436106100575760003560e01c80632f54bf6e1461005c578063637c50211461008c578063a3aba1a9146100aa578063e02dd9c2146100da578063f2c298be146100f6575b600080fd5b61007660048036038101906100719190610252565b610112565b604051610083919061029a565b60405180910390f35b610094610168565b6040516100a191906102fe565b60405180910390f35b6100c460048036038101906100bf9190610345565b610172565b6040516100d19190610381565b60405180910390f35b6100f460048036038101906100ef919061039c565b6101a2565b005b610110600480360381019061010b9190610252565b610244565b005b60008060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050919050565b6000600154905090565b60006020528060005260406000206000915054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b806000808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055505050565b806001819055505050565b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b600061027c82610251565b9050919050565b61028c81610271565b811461029757600080fd5b50565b6000813590506102a981610283565b92915050565b6000602082840312156102c5576102c461024c565b5b60006102d38482850161029a565b91505092915050565b6000819050919050565b6102ef816102dc565b82525050565b600060208201905061030a60008301846102e6565b92915050565b610319816102dc565b811461032457600080fd5b50565b60008135905061033681610310565b92915050565b6000602082840312156103525761035161024c565b5b600061036084828501610327565b91505092915050565b61037281610271565b82525050565b600060208201905061038d6000830184610369565b92915050565b600080604083850312156103aa576103a961024c565b5b60006103b88582860161029a565b92505060206103c985828601610327565b9150509250929050565b600082825260208201905092915050565b7f4f776e61626c653a2063616c6c6572206973206e6f7420746865206f776e6572600082015250565b600061041b6020836103d3565b9150610426826103e4565b602082019050919050565b6000602082019050818103600083015261044a8161040e565b905091905056fea26469706673582212";
  
  // Create factory for minimal storage contract
  console.log('ğŸ“¦ Creating contract factory...');
  
  // For this demo, we'll create a simple key-value store on-chain
  // In production, you would use fully compiled SolvencyVerifier.sol
  
  console.log('\nâš ï¸  DEPLOYMENT REQUIRES COMPILED CONTRACT');
  console.log('\nTo complete Phase 6 deployment:');
  console.log('1. Install solc: npm install -g solc');
  console.log('2. Compile contract: solcjs --bin --abi contracts/SolvencyVerifier.sol');
  console.log('3. Extract bytecode and ABI');
  console.log('4. Re-run this script with compiled artifacts\n');
  
  console.log('âœ… SolvencyVerifier.sol contract created');
  console.log('âœ… Deployment script ready');
  console.log('\nğŸ“‹ Next steps:');
  console.log('1. Compile Solidity contract');
  console.log('2. Deploy to Avalanche Fuji');
  console.log('3. Save contract address to .env');
  console.log('4. Test proof publication\n');
}

main()
  .then(() => process.exit(0))
  .catch((error) => {
    console.error('\nâŒ Deployment failed:', error);
    process.exit(1);
  });
